name: ğŸ” K6 Ejecucion Manual

on:
  workflow_dispatch:
    inputs:
      vus:
        description: 'Cantidad de Usuarios Virtuales (VU)'
        required: true
        default: '20'
      method:
        description: 'MÃ©todo HTTP'
        required: true
        type: choice
        options: [POST, GET, PUT, DELETE]
      endpoint:
        description: 'Endpoint a buscar (ej: login/directivo)'
        required: true

jobs:
  search_and_execute:
    name: ğŸš€ Buscar y Ejecutar en Cloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        uses: grafana/setup-k6-action@v1

      - name: ğŸ” Finding matching script
        id: search
        run: |
          # 1. Limpiar inputs y normalizar mÃ©todo a minÃºsculas
          METHOD_LOWER=$(echo "${{ github.event.inputs.method }}" | tr '[:upper:]' '[:lower:]' | xargs)
          ENDPOINT=$(echo "${{ github.event.inputs.endpoint }}" | xargs)
          
          echo "Buscando en todo el repositorio archivos *.test.js que contengan:"
          echo "MÃ©todo: http.$METHOD_LOWER"
          echo "Endpoint: $ENDPOINT"

          # 2. BÃºsqueda inteligente:
          # find . -name "*.test.js" -> Busca solo archivos de prueba
          # xargs grep -il -> Filtra los que tengan el mÃ©todo (ignorando mayÃºsculas)
          # xargs grep -il -> Filtra los que ADEMÃS tengan el endpoint (ignorando mayÃºsculas)
          MATCHED_FILE=$(find . -name "*.test.js" | xargs grep -il "http.$METHOD_LOWER" | xargs grep -il "$ENDPOINT" | head -n 1 || true)

          if [ -z "$MATCHED_FILE" ]; then
            echo "::error::âŒ No se encontrÃ³ ningÃºn archivo .test.js con el mÃ©todo $METHOD_LOWER y el endpoint $ENDPOINT"
            echo "found=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Archivo encontrado: $MATCHED_FILE"
            echo "found=true" >> $GITHUB_OUTPUT
            echo "file_path=$MATCHED_FILE" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš€ Run in K6 Cloud
        if: steps.search.outputs.found == 'true'
        env:
          K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}
          VUS: ${{ github.event.inputs.vus }}
        run: |
          FILE_PATH="${{ steps.search.outputs.file_path }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Ejecutando en la nube: $FILE_PATH"
          echo "ğŸ‘¥ Usuarios Virtuales: $VUS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Forzamos los VUs y una duraciÃ³n base para asegurar que no haga solo 1 iteraciÃ³n
          k6 cloud "$FILE_PATH" \
            --vus "$VUS" \
            -e VUS="$VUS" \
            -e TARGET_ENV="DEV" \
            -e URL_CERT="https://api01-siasis-cert.vercel.app" \
            -e URL_DEV="https://api01-siasis-dev.vercel.app" \
            -e NOMBRE_USUARIO_DIRECTIVO="${{ secrets.NOMBRE_USUARIO_DIRECTIVO }}" \
            -e CONTRASENA_DIRECTIVO="${{ secrets.CONTRASENA_DIRECTIVO }}" \
            -e NOMBRE_USUARIO_AUXILIAR="${{ secrets.NOMBRE_USUARIO_AUXILIAR }}" \
            -e CONTRASENA_AUXILIAR="${{ secrets.CONTRASENA_AUXILIAR }}" \
            -e NOMBRE_USUARIO_NO_TUTOR="${{ secrets.NOMBRE_USUARIO_NO_TUTOR }}" \
            -e CONTRASENA_NO_TUTOR="${{ secrets.CONTRASENA_NO_TUTOR }}" \
            -e NOMBRE_USUARIO_PERSONAL_ADMIN="${{ secrets.NOMBRE_USUARIO_PERSONAL_ADMIN }}" \
            -e CONTRASENA_PERSONAL_ADMIN="${{ secrets.CONTRASENA_PERSONAL_ADMIN }}" \
            -e NOMBRE_USUARIO_PROFESOR_PRIMARIA="${{ secrets.NOMBRE_USUARIO_PROFESOR_PRIMARIA }}" \
            -e CONTRASENA_PROFESOR_PRIMARIA="${{ secrets.CONTRASENA_PROFESOR_PRIMARIA }}" \
            -e NOMBRE_USUARIO_TUTOR="${{ secrets.NOMBRE_USUARIO_TUTOR }}" \
            -e CONTRASENA_TUTOR="${{ secrets.CONTRASENA_TUTOR }}" \
            -e DNI_ADMIN="${{ secrets.DNI_ADMIN }}" \
            -e DNI_AUXILIAR="${{ secrets.DNI_AUXILIAR }}"