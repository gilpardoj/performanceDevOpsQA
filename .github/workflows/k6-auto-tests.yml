name: K6 Validations

on:
  pull_request:
<<<<<<<<< Temporary merge branch 1
    branches: [ main, develop ]
    paths: [ 'API01/**/*.js' ] 

  workflow_dispatch: 
=========
    branches: [ main ]
    paths: [ 'API01/**/*.js' ]
  
  workflow_dispatch:
>>>>>>>>> Temporary merge branch 2
    inputs:
      environment:
        description: 'Ambiente'
        default: 'DEV'  
        type: choice
        options: [DEV, CERT] 

jobs:
  cloud_performance_test:
    name: üöÄ Run K6 in Grafana Cloud
    runs-on: ubuntu-latest
    env:
<<<<<<<<< Temporary merge branch 1
=========
      K6_CLOUD_TOKEN: ${{ secrets.K6_CLOUD_TOKEN }}

      TARGET_ENV: ${{ github.event.inputs.environment || 'DEV' }} 
      
>>>>>>>>> Temporary merge branch 2
      URL_CERT: "https://api01-siasis-cert.vercel.app"
      URL_CERT_INS2: "https://api01-siasis-cert-ins2.vercel.app"
      URL_CERT_INS3: "https://api01-siasis-cert-ins3.vercel.app"
      URL_DEV: "https://api01-siasis-dev.vercel.app"
      URL_DEV_INS2: "https://api01-siasis-dev-ins2.vercel.app"
      URL_PROD: "https://ie20935-api01-ins1.vercel.app"
      URL_PROD_INS2: "https://ie20935-api01-ins2.vercel.app"
      URL_PROD_INS3: "https://ie20935-api01-ins3.vercel.app"
<<<<<<<<< Temporary merge branch 1
      
      TARGET_ENV: ${{ github.event.inputs.environment || 'CERT' }}
=========
>>>>>>>>> Temporary merge branch 2

      NOMBRE_USUARIO_DIRECTIVO: ${{ secrets.NOMBRE_USUARIO_DIRECTIVO }}
      CONTRASENA_DIRECTIVO: ${{ secrets.CONTRASENA_DIRECTIVO }}
      NOMBRE_USUARIO_AUXILIAR: ${{ secrets.NOMBRE_USUARIO_AUXILIAR }}
      CONTRASENA_AUXILIAR: ${{ secrets.CONTRASENA_AUXILIAR }}
      NOMBRE_USUARIO_NO_TUTOR: ${{ secrets.NOMBRE_USUARIO_NO_TUTOR }}
      CONTRASENA_NO_TUTOR: ${{ secrets.CONTRASENA_NO_TUTOR }}
      NOMBRE_USUARIO_PERSONAL_ADMIN: ${{ secrets.NOMBRE_USUARIO_PERSONAL_ADMIN }}
      CONTRASENA_PERSONAL_ADMIN: ${{ secrets.CONTRASENA_PERSONAL_ADMIN }}
      NOMBRE_USUARIO_PROFESOR_PRIMARIA: ${{ secrets.NOMBRE_USUARIO_PROFESOR_PRIMARIA }}
      CONTRASENA_PROFESOR_PRIMARIA: ${{ secrets.CONTRASENA_PROFESOR_PRIMARIA }}
      NOMBRE_USUARIO_TUTOR: ${{ secrets.NOMBRE_USUARIO_TUTOR }}
      CONTRASENA_TUTOR: ${{ secrets.CONTRASENA_TUTOR }}
      DNI_ADMIN: ${{ secrets.DNI_ADMIN }}
      DNI_AUXILIAR: ${{ secrets.DNI_AUXILIAR }} 

    steps:
          - name: Checkout code
            uses: actions/checkout@v4
            with:
              fetch-depth: 2

          - name: Detect changed files
            id: changed-files
            uses: tj-actions/changed-files@v41
            with:
              files: 'API01/**/*.js'

          - name: Setup k6
            uses: grafana/setup-k6-action@v1

          - name: Run Tests in Cloud
            if: steps.changed-files.outputs.any_changed == 'true'
            run: |
              echo "‚òÅÔ∏è Iniciando ejecuci√≥n en Grafana Cloud (Ambiente: $TARGET_ENV)..."
              
              for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
                # Filtramos utilidades y helpers
                if [[ "$file" != *"urlManager.js"* ]] && [[ "$file" == API01/* ]]; then
                  
                  echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                  echo "üöÄ Enviando a la nube: $file"
                  
                  # --- AQU√ç EST√Å EL CAMBIO IMPORTANTE ---
                  # Pasamos cada variable con -e para que llegue a la nube
                  k6 cloud "$file" \
                    -e TARGET_ENV="$TARGET_ENV" \
                    -e URL_CERT="$URL_CERT" \
                    -e URL_CERT_INS2="$URL_CERT_INS2" \
                    -e URL_CERT_INS3="$URL_CERT_INS3" \
                    -e URL_DEV="$URL_DEV" \
                    -e URL_DEV_INS2="$URL_DEV_INS2" \
                    -e URL_PROD="$URL_PROD" \
                    -e URL_PROD_INS2="$URL_PROD_INS2" \
                    -e URL_PROD_INS3="$URL_PROD_INS3" \
                    -e NOMBRE_USUARIO_DIRECTIVO="$NOMBRE_USUARIO_DIRECTIVO" \
                    -e CONTRASENA_DIRECTIVO="$CONTRASENA_DIRECTIVO" \
                    -e NOMBRE_USUARIO_AUXILIAR="$NOMBRE_USUARIO_AUXILIAR" \
                    -e CONTRASENA_AUXILIAR="$CONTRASENA_AUXILIAR" \
                    -e NOMBRE_USUARIO_NO_TUTOR="$NOMBRE_USUARIO_NO_TUTOR" \
                    -e CONTRASENA_NO_TUTOR="$CONTRASENA_NO_TUTOR" \
                    -e NOMBRE_USUARIO_PERSONAL_ADMIN="$NOMBRE_USUARIO_PERSONAL_ADMIN" \
                    -e CONTRASENA_PERSONAL_ADMIN="$CONTRASENA_PERSONAL_ADMIN" \
                    -e NOMBRE_USUARIO_PROFESOR_PRIMARIA="$NOMBRE_USUARIO_PROFESOR_PRIMARIA" \
                    -e CONTRASENA_PROFESOR_PRIMARIA="$CONTRASENA_PROFESOR_PRIMARIA" \
                    -e NOMBRE_USUARIO_TUTOR="$NOMBRE_USUARIO_TUTOR" \
                    -e CONTRASENA_TUTOR="$CONTRASENA_TUTOR" \
                    -e DNI_ADMIN="$DNI_ADMIN" \
                    -e DNI_AUXILIAR="$DNI_AUXILIAR"
                  
                fi
              done